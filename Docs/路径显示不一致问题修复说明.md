# 路径显示不一致问题修复说明

## 问题描述

用户发现了一个奇怪的现象：
- **旅程tab**：路线显示偏离了地点标注（显示的是附近公路的路径）
- **旅程详情页的"旅程地图"**：显示了正确的路线（地点间的连线）

## 问题根源

两个视图使用了不同的数据源和计算逻辑：

### 1. 旅程tab（MapView）
- 使用 `tripRoutes[trip.id]` 存储路线
- 使用 `incremental: true` 模式，优先从 `RouteManager` 的缓存中读取
- **问题**：缓存中可能包含旧路线（使用机动车模式计算的），即使距离很近

### 2. 旅程详情页（TripRouteMapView）
- 每次都会调用 `routeManager.calculateRoutes(for: coordinates)` 重新计算
- 使用新的智能选择逻辑（近距离徒步，远距离机动车）
- **结果**：显示的是正确的路线

## 解决方案

在 `MapView` 的 `calculateRoutesForTrip` 方法中添加了缓存验证逻辑：

1. **检查缓存的交通方式是否合适**
   - 如果距离 ≤ 5公里，应该使用徒步模式
   - 如果缓存中使用的是机动车模式，说明是旧缓存

2. **自动清除不合适的缓存**
   - 检测到不合适的缓存时，自动清除
   - 强制重新计算，使用新的智能选择逻辑

3. **确保显示正确的路线**
   - 重新计算后，使用合适的交通方式（徒步/机动车）
   - 路线会正确连接地点，而不是连接到附近公路

## 技术实现

### 修改的文件
- `Footprint/Views/MapView.swift`

### 关键代码

```swift
// 检查缓存的路线是否使用了合适的交通方式
let cachedTransportType = cachedRoute.footprintTransportType
let shouldUseWalking = distance <= 5_000
let isUsingAutomobile = cachedTransportType.contains(.automobile) && cachedTransportType == .automobile

if shouldUseWalking && isUsingAutomobile {
    // 缓存的路线使用了不合适的交通方式，清除缓存并重新计算
    routeManager.clearRouteCache(from: source, to: destination)
    // 不添加到 calculatedRoutes，让后续重新计算
} else {
    calculatedRoutes[i] = cachedRoute
}
```

## 使用效果

### 之前
- 旅程tab显示错误的路线（连接到附近公路）
- 旅程详情页显示正确的路线
- 两个视图显示不一致

### 现在
- 两个视图都显示正确的路线
- 自动检测并清除不合适的缓存
- 使用智能交通方式选择（近距离徒步，远距离机动车）
- 路线正确连接地点，不会偏离

## 注意事项

1. **首次修复**：如果之前已经有错误的缓存，系统会自动检测并清除，然后重新计算正确的路线。

2. **性能影响**：清除缓存后需要重新计算路线，可能会有短暂的加载时间。

3. **缓存策略**：系统仍然会缓存计算好的路线，但会验证交通方式是否合适。

4. **向后兼容**：对于已经使用正确交通方式计算的路线，会继续使用缓存，不会重复计算。

## 测试建议

1. 在山上等无机动车道路的区域创建旅程
2. 添加多个近距离的打卡地点（距离 ≤ 5公里）
3. 查看旅程tab和旅程详情页的路线显示
4. 验证两个视图显示的路线是否一致且正确

---

**更新日期**：2025-01-XX
**版本**：v1.0

