# 路径计算徒步模式优化说明

## 问题描述

在山上等没有机动车道路的区域打卡时，旅程卡片显示的路径会连接到附近的公路，而不是实际的徒步路径。这是因为系统默认使用机动车模式（`.automobile`）计算路径。

## 解决方案

### 1. 智能交通方式选择

修改了 `RouteManager`，实现了智能交通方式选择：

- **近距离（≤5公里）**：优先使用徒步模式（`.walking`）
  - 适合山上、公园、景区等无机动车道路的场景
  - 路径更贴近实际行走路线
  
- **中等距离（5-1000公里）**：使用机动车模式（`.automobile`）
  - 适合城市间、跨区域旅行
  
- **远距离（>1000公里）**：使用任意模式（`.any`）
  - 提高路径计算成功率

### 2. 自动降级机制

如果徒步模式计算失败（例如某些区域没有步行路径数据），系统会自动尝试机动车模式作为备选，确保至少能显示一条路径。

### 3. 手动指定交通方式

`RouteManager` 现在支持手动指定交通方式：

```swift
// 强制使用徒步模式
routeManager.calculateRoute(
    from: source,
    to: destination,
    transportType: .walking
) { route in
    // 处理结果
}

// 自动选择（默认）
routeManager.calculateRoute(
    from: source,
    to: destination
) { route in
    // 系统会根据距离自动选择最佳交通方式
}
```

## 技术实现

### 修改的文件

- `Footprint/Helpers/RouteManager.swift`
  - 添加 `transportType` 参数支持
  - 实现智能交通方式选择逻辑
  - 添加徒步模式失败后的自动降级机制

### 关键代码

```swift
// 智能选择交通方式
let selectedTransportType: MKDirectionsTransportType
if let specifiedType = transportType {
    // 如果明确指定了交通方式，使用指定的
    selectedTransportType = specifiedType
} else {
    // 自动选择：近距离（5公里内）优先尝试徒步，远距离使用机动车
    if distance <= 5_000 {
        selectedTransportType = .walking
    } else if distance > 1_000_000 {
        selectedTransportType = .any
    } else {
        selectedTransportType = .automobile
    }
}
```

## 使用效果

### 之前
- 所有路径都使用机动车模式
- 山上打卡地点会显示连接到附近公路的路径
- 路径不准确，不符合实际行走路线
- 同一旅程的所有路段都使用相同的交通方式

### 现在
- **每段路径独立选择交通方式**：根据两点之间的距离自动判断
  - ≤5公里：自动使用徒步模式（适合山上、公园等场景）
  - 5-1000公里：自动使用机动车模式（适合城市间旅行）
  - >1000公里：使用任意模式（提高成功率）
- 山上打卡地点显示更贴近实际的徒步路径
- 路径更准确，符合实际行走路线
- **支持混合交通方式**：同一旅程中，近距离路段用徒步，远距离路段用机动车
- 如果徒步模式不可用，自动降级到机动车模式

### 混合交通方式示例

假设你的旅程包含以下地点：
1. 地点A → 地点B（距离3公里，山上徒步）→ 自动使用徒步模式
2. 地点B → 地点C（距离2公里，山上徒步）→ 自动使用徒步模式
3. 地点C → 地点D（距离50公里，坐车）→ 自动使用机动车模式

系统会为每段路径独立选择最合适的交通方式，无需手动设置！

## 注意事项

1. **缓存影响**：已缓存的路径（使用旧模式计算）仍会显示。如需更新，可以：
   - **方法1**：等待缓存过期（30天自动过期）
   - **方法2**：修改旅程中的任意地点（添加、删除或移动地点），系统会自动清除相关缓存并重新计算
   - **方法3**：在代码中调用 `RouteManager.shared.clearAllRouteCache()` 清除所有缓存（需要开发者操作）

2. **距离阈值**：5公里的阈值是根据常见徒步场景设置的。如果发现某些场景需要调整，可以修改 `RouteManager.swift` 中的 `5_000` 常量。

3. **路径数据依赖**：徒步模式的准确性依赖于 Apple Maps 的步行路径数据。在某些偏远地区，可能没有详细的步行路径数据，系统会自动降级到机动车模式。

4. **混合交通方式**：系统会自动为每段路径选择最合适的交通方式，无需手动设置。如果某段路径显示不正确，可以尝试修改该段路径的起点或终点位置，触发重新计算。

## 未来优化方向

1. **用户选择**：允许用户在旅程设置中选择交通方式（徒步/机动车/公共交通）
2. **场景识别**：根据地点类型（如"山峰"、"公园"）自动选择交通方式
3. **路径优化**：对于徒步场景，可以显示海拔变化、难度等级等信息

## 测试建议

1. 在山上或公园等无机动车道路的区域创建旅程
2. 添加多个打卡地点（距离在5公里内）
3. 查看旅程卡片和地图上的路径显示
4. 验证路径是否更贴近实际行走路线

---

**更新日期**：2025-01-XX
**版本**：v1.0

