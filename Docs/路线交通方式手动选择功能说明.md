# 路线交通方式手动选择功能说明

## 功能概述

在路线距离标注旁边添加了交通方式图标，用户可以点击图标选择该段路线的交通方式（徒步、机动车、公共交通或自动选择）。系统会保存用户的选择，并重新计算路线。

## 实现方案

### 1. UI 设计

在路线距离标注上添加了交通方式图标：
- **图标位置**：距离文本左侧
- **图标颜色**：根据当前交通方式显示不同颜色
  - 绿色：徒步
  - 蓝色：机动车
  - 紫色：公共交通
  - 灰色：自动选择
- **交互方式**：点击图标弹出菜单，选择交通方式

### 2. 数据存储

在 `RouteManager` 中添加了用户交通方式偏好存储：
- 使用文件持久化：`transportPreferences.json`
- 键值对存储：`routeKey -> transportType.rawValue`
- 线程安全：使用并发队列管理

### 3. 路线计算逻辑

优先级顺序：
1. **用户手动选择**：如果用户为某段路线设置了交通方式，优先使用
2. **自动选择**：如果没有用户选择，根据距离智能选择
   - ≤5公里：徒步
   - 5-1000公里：机动车
   - >1000公里：任意模式

### 4. 缓存管理

当用户更改交通方式时：
- 自动清除该路线的缓存
- 强制重新计算路线
- 更新地图显示

## 技术实现

### 修改的文件

1. **`Footprint/Helpers/RouteManager.swift`**
   - 添加 `userTransportPreferences` 存储用户偏好
   - 添加 `getUserTransportType` 和 `setUserTransportType` 方法
   - 添加偏好文件的加载和保存功能
   - 修改 `calculateRoute` 方法，优先使用用户选择

2. **`Footprint/Views/MapView.swift`**
   - 扩展 `RouteDistanceLabel` 组件，添加交通方式图标和菜单
   - 更新路线标注，传递交通方式信息和回调函数

3. **`Footprint/Views/TripRouteMapView.swift`**
   - 更新路线标注，支持交通方式选择

4. **本地化文件**
   - 添加交通方式相关的本地化字符串

### 关键代码

#### RouteDistanceLabel 组件

```swift
struct RouteDistanceLabel: View {
    let distance: CLLocationDistance
    let transportType: MKDirectionsTransportType
    let source: CLLocationCoordinate2D?
    let destination: CLLocationCoordinate2D?
    let onTransportTypeChange: ((MKDirectionsTransportType?) -> Void)?
    
    // 显示交通方式图标和距离
    // 点击图标弹出菜单选择交通方式
}
```

#### 用户偏好存储

```swift
// RouteManager
func setUserTransportType(
    from source: CLLocationCoordinate2D,
    to destination: CLLocationCoordinate2D,
    transportType: MKDirectionsTransportType?
) {
    // 保存用户选择
    // 清除缓存
    // 触发重新计算
}
```

## 使用流程

1. **查看路线**：在地图上看到路线和距离标注
2. **点击图标**：点击距离标注左侧的交通方式图标
3. **选择方式**：从菜单中选择：
   - 自动选择（恢复智能选择）
   - 徒步
   - 机动车
   - 公共交通
4. **重新计算**：系统自动清除缓存并重新计算路线
5. **更新显示**：地图上的路线和颜色自动更新

## 视觉效果

### 距离标注样式

```
┌─────────────────────┐
│ 🚶  138 公里        │  ← 点击图标选择交通方式
└─────────────────────┘
```

- 图标：根据交通方式显示不同图标和颜色
- 距离：显示路线距离
- 背景：半透明黑色，带白色描边

### 菜单选项

点击图标后显示：
- ✨ 自动选择
- ─────────
- 🚶 徒步
- 🚗 机动车
- 🚃 公共交通

## 注意事项

1. **性能影响**：更改交通方式会重新计算路线，可能需要几秒钟
2. **网络依赖**：路线计算需要网络连接
3. **缓存清除**：更改交通方式会自动清除该路线的缓存
4. **向后兼容**：旧版本的 `RouteDistanceLabel` 调用仍然有效（不显示图标）

## 未来优化方向

1. **批量设置**：允许为整个旅程设置默认交通方式
2. **智能建议**：根据地点类型（如"山峰"）自动建议使用徒步
3. **撤销功能**：添加撤销按钮，快速恢复自动选择
4. **视觉反馈**：在重新计算时显示加载动画

---

**更新日期**：2025-01-XX
**版本**：v1.0

