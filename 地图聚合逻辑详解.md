# 地图聚合逻辑详解

## 核心原理

地图聚合基于**两个关键因素**：
1. **地图缩放级别**（决定聚合距离）
2. **地点之间的实际地理距离**（判断是否聚合）

## 6个缩放级别详解

### 计算公式
```swift
缩放级别 = log2(360° ÷ 地图经度跨度)
```

| 级别 | 缩放值 | 视野范围 | 聚合距离 | 典型场景 |
|-----|-------|---------|---------|---------|
| 1️⃣ | < 4 | 全球/洲际 | **250 km** | 查看世界旅行分布 |
| 2️⃣ | 4-6 | 国家级别 | **100 km** | 查看一个国家的足迹 |
| 3️⃣ | 6-8 | 省/州级别 | **50 km** | 查看省份内的旅行 |
| 4️⃣ | 8-10 | 城市圈 | **25 km** | 查看城市群分布 |
| 5️⃣ | 10-12 | 单个城市 | **5 km** | 查看城市内的地点 |
| 6️⃣ | > 12 | 街区/街道 | **0 km（不聚合）** | 查看具体每个地点 |

## 聚合判断逻辑

### 步骤1：确定聚合距离
根据当前地图缩放级别，选择对应的聚合距离阈值。

**示例**：
- 缩放级别 = 5（国家视图）→ 聚合距离 = 100km
- 缩放级别 = 13（街道视图）→ 聚合距离 = 0km（不聚合）

### 步骤2：计算地点距离
对每个地点，计算它与其他地点之间的**实际地理距离**（单位：米）。

```swift
实际距离 = CLLocation.distance(from: 地点A, to: 地点B)
```

### 步骤3：判断是否聚合

```
如果 实际距离 < 聚合距离：
    ✅ 聚合显示（合并为一个标记）
否则：
    ❌ 分开显示（各自独立标记）
```

## 实际案例说明

### 案例1：全球视图（缩放级别 = 3）

**场景**：打开地图，显示所有旅行足迹

```
聚合距离：250 km

地点列表：
- 北京 (39.9°N, 116.4°E)
- 天津 (39.1°N, 117.2°E) → 距北京约 120km ✅ 聚合
- 上海 (31.2°N, 121.5°E) → 距北京约 1200km ❌ 分开
- 东京 (35.7°N, 139.7°E) → 距上海约 1800km ❌ 分开

显示结果：
🔴 [北京+天津] 2个地点
🔴 [上海] 1个地点
🔵 [东京] 1个地点
```

### 案例2：国家视图（缩放级别 = 5）

**场景**：放大到中国范围

```
聚合距离：100 km

地点列表：
- 北京 (39.9°N, 116.4°E)
- 天津 (39.1°N, 117.2°E) → 距北京约 120km ❌ 分开
- 石家庄 (38.0°N, 114.5°E) → 距北京约 280km ❌ 分开
- 上海 (31.2°N, 121.5°E) → 距北京约 1200km ❌ 分开

显示结果：
🔴 [北京] 1个地点
🔴 [天津] 1个地点
🔴 [石家庄] 1个地点
🔴 [上海] 1个地点
```

### 案例3：省级视图（缩放级别 = 7）

**场景**：聚焦河北省

```
聚合距离：50 km

地点列表：
- 北京市区 (39.9°N, 116.4°E)
- 天津市区 (39.1°N, 117.2°E) → 距北京约 120km ❌ 分开
- 北京郊区 (40.2°N, 116.2°E) → 距北京市区约 35km ✅ 聚合

显示结果：
🔴 [北京市区+北京郊区] 2个地点
🔴 [天津市区] 1个地点
```

### 案例4：城市视图（缩放级别 = 11）

**场景**：查看北京市内

```
聚合距离：5 km

地点列表：
- 天安门 (39.908°N, 116.397°E)
- 故宫 (39.916°N, 116.397°E) → 距天安门约 0.9km ✅ 聚合
- 颐和园 (39.999°N, 116.275°E) → 距天安门约 14km ❌ 分开
- 长城 (40.432°N, 116.570°E) → 距天安门约 60km ❌ 分开

显示结果：
🔴 [天安门+故宫] 2个地点
🔴 [颐和园] 1个地点
🔴 [长城] 1个地点
```

### 案例5：街道视图（缩放级别 = 13）

**场景**：放大到具体街区

```
聚合距离：0 km（不聚合）

地点列表：
- 天安门 (39.908°N, 116.397°E)
- 故宫 (39.916°N, 116.397°E) → 即使很近也不聚合
- 王府井 (39.915°N, 116.407°E) → 不聚合

显示结果：
🔴 [天安门] 1个地点
🔴 [故宫] 1个地点
🔴 [王府井] 1个地点
```

## 聚合算法流程

```
1. 获取当前地图缩放级别
   ↓
2. 根据缩放级别确定聚合距离阈值
   ↓
3. 如果聚合距离 = 0：
   → 所有地点独立显示（结束）
   ↓
4. 如果聚合距离 > 0：
   ↓
5. 遍历所有地点：
   - 创建新聚合组，加入当前地点
   - 查找所有未处理的地点
   - 计算距离，如果 < 聚合距离，加入聚合组
   - 标记已处理
   ↓
6. 为每个聚合组创建标记：
   - 如果只有1个地点：显示单点标记
   - 如果有多个地点：显示聚合标记+数量
```

## 动态交互

### 放大地图时
```
缩放级别增加 → 聚合距离减小 → 聚合组自动分离

例如：
级别 5 (100km) 🔴 [北京+天津] 2个地点 (距离约120km)
    ↓ 放大
级别 7 (50km) 🔴 [北京] 1个地点  🔴 [天津] 1个地点
```

### 缩小地图时
```
缩放级别减小 → 聚合距离增大 → 分散地点自动聚合

例如：
级别 13 (0km) 🔴 [天安门]  🔴 [故宫]  🔴 [王府井]
    ↓ 缩小
级别 11 (5km) 🔴 [天安门+故宫+王府井] 3个地点
```

### 点击聚合标记
```
用户点击 🔴 [北京+天津] 2个地点
    ↓
地图自动放大到该区域
    ↓
聚合距离减小
    ↓
自动分离显示：🔴 [北京]  🔴 [天津]
```

## 设计优势

### 1. 自适应显示
- ✅ 全局视图：高度聚合，清晰显示足迹分布
- ✅ 局部视图：逐渐展开，发现更多细节
- ✅ 街道视图：完全展开，精确定位

### 2. 性能优化
- ✅ 远距离视图：减少标记数量，提升性能
- ✅ 近距离视图：显示所有细节，完整信息

### 3. 用户体验
- ✅ 直观理解：数字显示该区域有多少地点
- ✅ 探索发现：点击聚合标记自动展开
- ✅ 平滑过渡：放大缩小时自然变化

## 实现细节

### 距离计算
```swift
// 使用 CoreLocation 计算实际地理距离
func distance(to other: CLLocationCoordinate2D) -> Double {
    let location1 = CLLocation(latitude: self.latitude, longitude: self.longitude)
    let location2 = CLLocation(latitude: other.latitude, longitude: other.longitude)
    return location1.distance(from: location2) // 返回米数
}
```

### 聚合中心点
```swift
// 聚合标记显示在所有地点的平均位置
聚合中心纬度 = (地点1纬度 + 地点2纬度 + ... + 地点N纬度) ÷ N
聚合中心经度 = (地点1经度 + 地点2经度 + ... + 地点N经度) ÷ N
```

### 避免重复聚合
```swift
// 使用 Set 记录已处理的地点
var processed: Set<UUID> = []

// 每个地点只会被加入一个聚合组
if processed.contains(destination.id) { continue }
```

## 总结

这套聚合逻辑模仿了 iPhone 照片应用的地图显示方式：
- 🌍 **远看分布**：世界视图下看大的地理分布
- 🏙️ **中看区域**：国家/省份视图下看区域分布
- 🏘️ **近看细节**：城市/街道视图下看具体地点

通过智能的距离判断，在任何缩放级别都能提供最佳的视觉体验！

---

*最后更新：2025年10月19日*

